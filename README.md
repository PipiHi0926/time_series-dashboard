# FAB KPI 時序資料異常監控 Dashboard

基於 Streamlit 的 FAB KPI 時序資料異常監控儀表板，專為半導體製造廠設計，支援多種異常偵測方法和時序分析，適用於每日一點的 KPI 資料分析。

## 功能特色

### 🏭 FAB 數據管理
- 支援 FAB, VALUE, KPI, REPORT_TIME 標準資料格式
- 支援 CSV、Excel 格式文件上傳
- 自動 FAB 選擇和 KPI 篩選功能
- 提供真實 FAB KPI 範例數據（良率、產能、缺陷率等）
- 即時數據預覽和統計資訊

### 🔍 異常偵測方法

#### 1. 統計方法偵測
- **Z-Score**: 基於標準分數的異常偵測
- **Modified Z-Score**: 使用中位數絕對偏差的穩健統計方法
- **IQR 四分位距**: 基於箱型圖原理的異常偵測
- 可調整異常閾值參數

#### 2. 移動平均偵測
- **簡單移動平均 (SMA)**: 固定窗口平均值偵測
- **指數移動平均 (EMA)**: 加權移動平均偵測
- **滾動標準差偵測**: 基於滾動統計的動態閾值
- 可自定義窗口大小和偏離閾值

#### 3. 季節性分解偵測
- **加法模型**: 趨勢 + 季節性 + 殘差
- **乘法模型**: 趨勢 × 季節性 × 殘差
- 支援多種季節週期 (7天、30天、90天、365天)
- 基於殘差分析的異常偵測

### 📈 時序分析功能

#### 1. 趨勢分析
- 線性趨勢檢測和顯著性檢驗
- 多種移動平均線比較
- 趨勢變化率分析

#### 2. 週期性分析
- FFT 頻譜分析找出主要週期
- 週間模式統計分析
- 自相關函數分析

#### 3. 自相關分析
- 短期和長期依賴性檢測
- 顯著滯後識別
- 持續性評估

#### 4. 變點檢測
- 統計變化點自動檢測
- 穩定性評分
- 分段分析

#### 5. 時序分解
- Seasonal-Trend decomposition
- 趨勢和季節性強度評估
- 組件視覺化

#### 6. 異常模式分析
- 多變量異常檢測
- PCA 降維分析
- 馬氏距離異常評分
- KPI 相關性分析

### 🚀 進階分析功能

#### Level Shift 檢測
- **前後比較分析**: 可自定義比較窗口大小 (3-30天)
- **統計顯著性檢驗**: t-檢驗判斷變化是否顯著
- **變化幅度量化**: 計算變化百分比和方向
- **智能解釋生成**: 自動生成異常原因和建議
- **視覺化標記**: 在時序圖上清楚標示 Level Shift 點
- **詳細分析報告**: 包含變化前後統計資訊

#### 趨勢動量分析
- **多時間窗口比較**: 支援短期 (3-14天) vs 長期 (14-90天) 趨勢對比
- **連續趨勢檢測**: 自動識別持續上升或下降的時期
- **趨勢加速度分析**: 檢測趨勢變化的加速或減速
- **動量信號計算**: 短期趨勢減去長期趨勢的動量指標
- **趨勢強度評估**: 評估趨勢的強度和一致性
- **智能解釋系統**: 根據 KPI 類型提供針對性解釋

### 📊 敘述統計分析
- **智能數據類型推斷**: 自動識別連續型、計數型、二元型、稀疏事件等數據類型
- **全面統計檢驗**: Shapiro-Wilk、D'Agostino-Pearson、Jarque-Bera、KS檢驗等常態性檢驗
- **數據特性分析**: 偏度、峰度、異常值、趨勢性、平穩性、週期性等特徵分析
- **稀疏性分析**: 零值比例、連續零值序列、數據密度等稀疏特性評估
- **KPI智能標籤系統**: 自動生成數據特性標籤 (NORMAL/NON_NORMAL, SPARSE, TREND_*, etc.)
- **方法論推薦引擎**: 根據KPI特性自動推薦最適合的分析方法
- **可視化分析**: 時序圖、分布直方圖、Q-Q圖、箱型圖等多維度視覺化

### 📊 批量監控功能

#### KPI 批量監控
- 同時監控多個 KPI
- 異常率統計和排名
- 風險等級分類（高/中/低風險）
- 組合偵測方法
- 批量異常點識別和分析

### 🎨 視覺化功能
- 互動式 Plotly 時序圖表
- 異常點高亮顯示和標記
- 移動平均線和置信區間
- 季節性分解多組件展示
- PCA 降維視覺化
- 頻譜分析圖表
- 自相關函數圖
- 異常點詳細資訊表格
- KPI 風險等級分佈圖
- 批量監控儀表板

## 安裝與執行

### 1. 安裝依賴套件
```bash
pip install -r requirements.txt
```

### 2. 啟動應用程式
```bash
# 方法 1: 直接使用 Streamlit
streamlit run app.py

# 方法 2: 使用 Python 腳本
python run.py

# 方法 3: Windows 用戶雙擊
run.bat
```

### 3. 開啟瀏覽器
應用程式將在 `http://localhost:8501` 啟動

## 使用指南

### 第一步：上傳 FAB 數據
1. 點選左側選單中的「數據上傳與FAB選擇」
2. 上傳包含 FAB, VALUE, KPI, REPORT_TIME 欄位的 CSV 或 Excel 文件
3. 或點擊「🎯 使用範例數據」載入示範資料
4. 選擇要分析的 FAB
5. 確認數據預覽和 KPI 概覽

### 第二步：選擇分析方法
從左側選單選擇適合的分析方法：

- **敘述統計分析**: 全面的 KPI 特性分析和方法論推薦
- **統計方法偵測**: 適用於無明顯趨勢和季節性的數據
- **移動平均偵測**: 適用於有趨勢但季節性不明顯的數據  
- **季節性分解偵測**: 適用於具有明顯季節性模式的數據
- **時序分析**: 深度分析趨勢、週期性、自相關等特性
- **KPI批量監控**: 同時監控多個 KPI 的異常狀況
- **Level Shift 檢測**: 檢測顯著的水準變化和跳躍
- **趨勢動量分析**: 分析短期 vs 長期趨勢動量和連續變化
- **異常趨勢分析**: 分析異常模式和趨勢（開發中）

### 第三步：設定參數
根據數據特性和業務需求調整參數：
- 異常閾值和置信水準
- 移動平均窗口大小
- 季節週期設定
- 統計方法選擇

### 第四步：執行分析
點擊「🔍 執行分析」按鈕，查看結果：
- 時序圖表和異常點標記
- 統計摘要和評估指標
- 異常點詳細列表和排名
- 趨勢和週期性分析結果

## 數據要求

### 標準格式要求
必須包含以下四個欄位：
- **FAB**: 工廠識別碼 (字串)
- **KPI**: KPI 指標名稱 (字串) 
- **VALUE**: KPI 數值 (數值)
- **REPORT_TIME**: 報告時間 (日期時間格式)

### 支援的 KPI 類型
系統支援多種真實的製造業 KPI 類型，包含不同的數據分布特性：

#### 連續型 KPI
- **Yield**: 良率 (%) - 百分比型，通常接近常態分布
- **Throughput**: 產能 (units/day) - 計數型，右偏分布
- **Equipment_Utilization**: 設備利用率 (%) - 百分比型，週期性模式
- **Cycle_Time**: 週期時間 (hours) - 持續時間型，右偏Gamma分布
- **Cost_Per_Unit**: 單位成本 (USD) - 貨幣型，通膨趨勢

#### 計數型 KPI (泊松分布)
- **Defect_Count**: 缺陷計數 - 稀有事件，泊松分布
- **Critical_Alerts**: 關鍵警報數 - 低頻事件，高變異性
- **Maintenance_Events**: 維護事件數 - 週期性泊松過程

#### 二元型 KPI
- **Line_Down_Flag**: 產線停機標誌 (0/1) - 二元稀有事件
- **Quality_Pass_Flag**: 品質通過標誌 (0/1) - 高通過率二元型

#### 稀疏事件型 KPI
- **Equipment_Failure**: 設備故障 - 極稀疏事件 (1% 發生率)
- **Process_Excursion**: 製程偏移 - 超稀疏事件 (0.5% 發生率)

### 數據建議
- **時序資料**: 建議每日一點，數據點越多分析效果越好
- **數據完整性**: 盡量避免缺失值
- **時間範圍**: 至少 30 天資料，季節性分析需要 60+ 天
- **多 FAB**: 支援多個 FAB 同時上傳，可單獨選擇分析

## 技術架構

### 核心技術
- **Streamlit**: Web 應用框架
- **Pandas**: 數據處理和時序操作
- **NumPy**: 數值計算和陣列處理
- **Plotly**: 互動式圖表和儀表板
- **Statsmodels**: 時序分析和季節性分解
- **Scikit-learn**: 機器學習和異常檢測
- **SciPy**: 統計分析和信號處理

### 異常偵測算法
- **統計方法**: Z-Score, Modified Z-Score, IQR 基於機率分佈理論
- **時序方法**: 移動平均, 指數平滑, 滾動統計
- **分解方法**: STL 季節性趨勢分解, 殘差分析
- **機器學習**: PCA 降維, 馬氏距離, 多變量異常檢測
- **信號處理**: FFT 頻譜分析, 自相關函數, 變點檢測

### 時序分析功能
- **趨勢分析**: 線性回歸, 顯著性檢驗, 變化率計算
- **週期性分析**: 傅立葉變換, 頻域分析, 週間模式
- **相關性分析**: 自相關, 偏自相關, 滯後分析
- **穩定性分析**: 變點檢測, 分段統計, 穩定性評分

## 檔案結構
```
kpi_oob_dashboard/
├── app.py                      # 主應用程式和核心功能
├── batch_monitoring.py        # KPI 批量監控模組
├── time_series_analysis.py    # 時序分析功能模組
├── advanced_analysis.py       # Level Shift 和趨勢動量分析模組
├── descriptive_stats.py       # 敘述統計分析和 KPI 特性分析模組
├── realistic_data_generator.py # 真實 FAB 數據生成器
├── .streamlit/
│   └── config.toml            # Streamlit 主題配置
├── requirements.txt           # 依賴套件清單
├── run.py                     # Python 啟動腳本
├── run.bat                    # Windows 批次檔啟動腳本
└── README.md                 # 完整說明文檔
```

## 進階功能

### FAB 專用設計
- 針對半導體製造業 KPI 特性優化
- 支援多 FAB 多 KPI 同時分析
- 內建 8 種典型 FAB KPI 範例資料
- 適應製造業的季節性和週期性特徵

### 智能分析
- 自動識別最佳分析方法
- 動態調整參數建議
- 多層次異常檢測
- 異常根因分析提示

### 擴展性設計
- 模組化架構易於擴展
- 支援自定義偵測算法
- 可整合外部數據源
- 支援批次處理和排程執行

## 未來發展

### 計畫中功能
- **機器學習偵測**: Isolation Forest, LSTM AutoEncoder, ARIMA 模型
- **多變量分析**: 交叉相關分析, 格蘭傑因果檢驗
- **預測功能**: 時序預測, 異常預警
- **告警系統**: 即時監控, 郵件通知, 儀表板告警
- **報告匯出**: PDF 報告, Excel 分析結果, 自動化報告
- **數據連接**: 數據庫連接, API 接口, 即時數據流

### 效能優化
- 大數據處理優化
- 分散式計算支援
- 快取機制
- 響應式設計

## 最佳實踐

### 數據準備
1. **數據品質**: 確保數據完整性, 處理缺失值
2. **時間對齊**: 統一時間格式, 處理時區問題  
3. **異常值預處理**: 識別和處理明顯錯誤的數據點
4. **採樣頻率**: 保持一致的採樣間隔

### 參數調整
1. **閾值設定**: 根據業務容忍度調整敏感度
2. **窗口大小**: 考慮數據特性和反應速度
3. **季節週期**: 根據實際業務週期設定
4. **方法選擇**: 結合數據特徵選擇適當方法

### 結果解釋
1. **異常驗證**: 結合業務知識驗證異常點
2. **趨勢分析**: 關注長期趨勢變化
3. **根因分析**: 結合製程數據分析異常原因
4. **持續改進**: 根據回饋優化參數設定

## 故障排除

### 常見問題
1. **數據格式錯誤**: 檢查欄位名稱和資料類型
2. **記憶體不足**: 減少分析的數據量或時間範圍
3. **計算時間過長**: 調整參數或使用較簡單的方法
4. **結果不合理**: 檢查數據品質和參數設定

### 效能建議
1. 大於 10MB 的檔案建議分批處理
2. 超過 1 年的數據建議使用採樣
3. 多個 KPI 同時分析時建議分組處理
4. 複雜分析建議在本地環境執行

## 支援與回饋
如有問題或建議，請檢查：
1. **數據格式**: FAB, VALUE, KPI, REPORT_TIME 欄位是否正確
2. **依賴套件**: 是否安裝了所有必要的 Python 套件
3. **參數設定**: 根據數據特性調整分析參數
4. **系統資源**: 確保有足夠的記憶體和計算資源

技術支援：GitHub Issues 或聯繫開發團隊