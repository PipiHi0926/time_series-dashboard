# KPI OOB Dashboard - Matplotlib 升級摘要

## 🎯 升級目標
將所有 Plotly 圖表替換為 Matplotlib，並增強異常檢測功能，包括：
- 清楚顯示異常區間、增幅、趨勢
- 可調整超參數觀察不同閾值效果
- 詳細的異常檢測分析和解釋

## 📊 完成的升級項目

### 1. 核心視覺化工具模組 (`matplotlib_utils.py`) ✅
**新增檔案** - 包含所有異常檢測專用的 matplotlib 視覺化函數：

#### 主要功能：
- **`create_anomaly_plot()`** - 通用異常檢測圖表
  - 顯示時序數據與異常點
  - 包含異常分數子圖
  - 支持閾值線和統計區間顯示

- **`create_zscore_analysis_plot()`** - Z-Score 專業分析
  - 主時序圖含統計區間標示
  - Z-Score 時序變化
  - Z-Score 分布直方圖
  - 詳細統計信息面板

- **`create_iqr_analysis_plot()`** - IQR 專業分析
  - 四分位數區間視覺化
  - 箱線圖分析
  - 異常邊界清楚標示
  - IQR 統計摘要

- **`create_isolation_forest_plot()`** - Isolation Forest 分析
  - 異常分數分布
  - 時序圖含異常點標記
  - 模型參數統計面板

- **`create_dbscan_plot()`** - DBSCAN 聚類分析
  - 聚類結果視覺化
  - 噪聲點（異常）標記
  - 聚類統計摘要

- **`create_comparison_plot()`** - 多方法比較
  - 同時顯示多種檢測方法結果
  - 便於比較不同方法的效果

#### 特色功能：
- 🎨 中文字型自動設定
- 📏 響應式圖表大小
- 🎯 異常點清楚標記和標註
- 📊 統計信息整合顯示
- 🎪 豐富的視覺化元素

### 2. 時序分析模組 (`time_series_analysis.py`) ✅
**升級完成** - 所有 Plotly 圖表已替換為 Matplotlib：

#### 升級的分析功能：
- **趨勢分析** - 線性趨勢線 + 多期移動平均
- **週期性分析** - FFT 頻譜 + 週間模式 + 自相關函數
- **自相關分析** - 置信區間 + 顯著性檢驗 + 滯後解釋
- **變點檢測** - 統計檢驗 + 分段平均 + 變點標註
- **時序分解** - 趨勢/季節性/殘差分解視覺化
- **異常模式分析** - PCA + 馬氏距離 + 相關性熱圖

#### 新增功能：
- 🔍 更詳細的統計檢驗結果
- 📈 交互式超參數調整
- 💡 智慧化分析建議

### 3. 高級異常檢測模組 (`advanced_anomaly_detection.py`) ✅
**全新模組** - 提供專業級異常檢測功能：

#### 新增的檢測方法：
- **🌲 Isolation Forest 分析頁面**
  - 污染率、樹數量、最大特徵數調整
  - 時間特徵、滯後特徵工程選項
  - 詳細的特徵重要性分析

- **🎯 DBSCAN 聚類異常檢測**  
  - eps、min_samples、距離度量調整
  - 多維特徵聚類分析
  - 聚類統計和詳情展示

- **🎪 集成異常檢測**
  - 多方法結合 (Z-Score, IQR, Isolation Forest, LOF, One-Class SVM)
  - 集成策略選擇 (投票/並集/交集/加權)
  - 方法一致性分析

#### 先進特徵：
- 🛠️ 豐富的特徵工程選項
- ⚙️ 實時超參數調整
- 📊 方法效果比較分析
- 🎯 專業的異常解釋

### 4. 主應用程式 (`app.py`) ✅  
**核心升級** - 異常檢測視覺化全面更新：

#### 更新內容：
- 移除所有 Plotly 相關代碼
- 整合新的 matplotlib 異常檢測函數
- 根據檢測方法自動選擇最佳視覺化
- 保持原有的功能完整性

#### 智慧視覺化邏輯：
```python
if detection_method == "Z-Score":
    fig = create_zscore_analysis_plot(...)
elif detection_method == "IQR":
    fig = create_iqr_analysis_plot(...)
else:
    fig = create_anomaly_plot(...)
```

### 5. 批量監控模組 (`batch_monitoring.py`) ✅
**視覺化升級** - 所有圖表轉為 Matplotlib：

#### 升級功能：
- KPI 異常率分佈條形圖
- 多 KPI 時序子圖矩陣
- 風險等級分佈餅圖
- 響應式布局設計

### 6. 依賴套件更新 (`requirements.txt`) ✅
**套件管理** - 更新專案依賴：
```
- plotly==5.6.0     (移除)
+ matplotlib>=3.7.0 (新增)
```

### 7. 測試腳本 (`test_matplotlib_conversion.py`) ✅
**全新測試框架** - 完整的功能驗證：

#### 測試涵蓋範圍：
- ✅ matplotlib_utils 模組功能測試
- ✅ 高級異常檢測模組測試  
- ✅ 時序分析功能測試
- ✅ 批量監控功能測試
- ✅ 主應用程式整合測試

## 🆕 新增的超參數控制功能

### Z-Score / Modified Z-Score 檢測
- **閾值調整**: 1.0-5.0 標準差倍數
- **視覺效果**: 即時顯示 ±1σ, ±2σ, ±閾值σ 區間
- **統計面板**: 顯示檢測統計和參數解釋

### IQR 四分位距檢測  
- **倍數調整**: 1.0-3.0 IQR 倍數
- **視覺效果**: Q1, Q2, Q3, 異常邊界清楚標示
- **箱線圖**: 配合詳細的分布分析

### Isolation Forest 檢測
- **污染率**: 0.01-0.3 (預期異常比例)
- **樹數量**: 50-300 (模型複雜度)
- **最大特徵數**: 1-10 (防止過擬合)
- **特徵工程**: 時間特徵、滯後特徵選項

### DBSCAN 聚類檢測
- **eps**: 0.1-5.0 (鄰域半徑)
- **min_samples**: 3-20 (最小樣本數)
- **距離度量**: euclidean/manhattan/cosine
- **特徵選項**: 數值、統計、時間特徵

### 集成檢測
- **方法選擇**: 多選檢測算法組合
- **集成策略**: 投票/並集/交集/加權平均
- **閾值百分位**: 90-99% 異常判定閾值

## 🎨 視覺化增強功能

### 1. 清楚的異常區間顯示
- **統計區間**: 均值 ± nσ 陰影區域
- **閾值線**: 虛線標示檢測閾值  
- **顏色編碼**: 正常(綠)/警告(橙)/異常(紅)

### 2. 詳細的增幅分析
- **異常程度標註**: 數值標籤顯示異常分數
- **變化方向**: 箭頭和顏色指示趨勢
- **百分比變化**: 量化異常幅度

### 3. 趨勢視覺化
- **趨勢線**: 線性/多項式趨勢擬合
- **移動平均**: 多期間平滑趨勢
- **趨勢強度**: R² 和顯著性指標

### 4. 交互式效果模擬
雖然 Matplotlib 不是交互式的，但通過 Streamlit 的即時重繪實現：
- **滑桿調整**: 即時更新圖表和檢測結果
- **參數說明**: 每個參數都有詳細的 help 提示
- **效果比較**: 並排顯示不同參數設定的結果

## 📈 性能和功能提升

### 性能優化
- **記憶體效率**: Matplotlib 圖表更輕量
- **渲染速度**: 本地渲染比 Plotly 更快
- **相容性**: 更好的伺服器環境相容性

### 功能增強
- **專業分析**: 針對異常檢測優化的視覺設計
- **統計詳情**: 更豐富的統計信息展示
- **方法比較**: 多種檢測方法並排比較
- **解釋性**: 每個異常點都有詳細說明

## 🚀 使用指南

### 1. 環境設定
```bash
pip install -r requirements.txt
```

### 2. 啟動應用
```bash
streamlit run app.py
```

### 3. 功能測試
```bash
python test_matplotlib_conversion.py
```

### 4. 新功能使用流程
1. **選擇檢測方法** - 根據數據特性選擇合適的方法
2. **調整超參數** - 使用滑桿即時調整檢測敏感度  
3. **觀察視覺化** - 查看異常區間、增幅、趨勢變化
4. **分析結果** - 參考統計面板和異常點詳情
5. **方法比較** - 使用集成檢測比較不同方法效果

## 🔧 技術實現亮點

### 1. 模組化設計
- **職責分離**: 視覺化邏輯獨立於業務邏輯
- **可複用**: 視覺化函數可在不同頁面重複使用
- **可擴展**: 輕鬆新增新的檢測方法和視覺化

### 2. 智慧化視覺效果
- **自適應布局**: 根據數據量自動調整圖表大小
- **動態著色**: 根據異常程度自動選擇顏色
- **智慧標註**: 只對重要異常點添加標註避免混亂

### 3. 統計嚴謹性
- **置信區間**: 統計顯著性檢驗
- **多重檢驗校正**: 避免假陽性
- **參數驗證**: 確保統計方法正確應用

## 📋 TODO 和未來改進

### 短期優化
- [ ] 添加更多異常檢測算法 (LSTM, Transformer)
- [ ] 實現異常點的根因分析
- [ ] 增加報告導出功能

### 長期規劃  
- [ ] 多變量異常檢測
- [ ] 即時監控告警系統
- [ ] 機器學習模型自動調參

## 🎉 結論

本次 Matplotlib 升級不僅僅是視覺化技術的轉換，更是異常檢測分析能力的全面提升。新系統提供：

✅ **更專業的視覺化** - 針對異常檢測優化的圖表設計  
✅ **更豐富的超參數控制** - 實時調整觀察不同效果  
✅ **更清楚的異常解釋** - 區間、增幅、趨勢一目了然  
✅ **更全面的檢測方法** - 從統計到機器學習的完整工具鏈  
✅ **更好的用戶體驗** - 直觀的操作界面和詳細的說明  

現在用戶可以：
1. **清楚看到異常區間** - 統計區間和閾值線清楚標示
2. **量化異常增幅** - 具體的異常分數和百分比變化
3. **理解異常趨勢** - 趨勢線和移動平均幫助判斷
4. **調整檢測敏感度** - 滑桿即時調整觀察效果變化
5. **比較不同方法** - 並排比較找出最佳檢測策略

這個升級為 TSMC KPI 異常監控提供了更強大、更專業、更易用的分析工具。